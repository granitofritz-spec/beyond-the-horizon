<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="dashboard-container">
    
    <aside class="sidebar">
      <div class="sidebar-user" id="sidebar-welcome">
        Loading...
      </div>
      <nav>
        <button class="sidebar-nav-btn active" data-tab="overview">Overview</button>
        <button class="sidebar-nav-btn" data-tab="achievements">Achievements</button>
        <button class="sidebar-nav-btn" data-tab="shop">Shop</button>
        <button class="sidebar-nav-btn" data-tab="settings">Settings</button>
        <button id="mobile-logout" class="sidebar-nav-btn" style="display: none;">Logout</button>
      </nav>
    </aside>
    
    <div class="main-content-wrapper">
      
      <header class="top-bar">
        <button id="logoutBtn" class="btn" style="background: var(--sunset); color: #fff; padding: 8px 14px; margin: 0; font-size: 0.9rem;">Logout</button>
      </header>
      
      <main class="content-area">
        
        <section id="page-overview" class="dashboard-page active">
          
          <div class="card" id="announcement-card" style="display: none; background-color: var(--card-bg); color: #333; margin-bottom: 1.5rem;">
            <h3>A Message from the Devs</h3>
            <p id="announcement-text"></p>
            <p id="announcement-meta" class="small-muted" style="color: rgba(0,0,0,0.7); margin: 0;"></p>
          </div>
          
          <div class="content-grid" style="margin-top: 1.5rem;">
            <div class="card">
              <h2>Your Progress</h2>
              <p>Level <span id="overview-level">1</span> - Explorer</p>
              <div class="progress-bar"><div class="progress"></div></div>
            </div>

            <div class="card">
              <h2>Inventory</h2>
              <p>- Wooden Axe<br>- Coconut Water<br>- Leaf Shelter Blueprint</p>
            </div>

            <div class="card">
              <h2>Map</h2>
              <p>The eastern shore remains unexplored...</p>
            </div>
            
          </div>
        </section>
        
        <section id="page-settings" class="dashboard-page">
          <h2>Settings</h2>
          <div class="content-grid">
            
            <div class="card">
              <h3>Account</h3>
              <div class="form-field">
                <label for="setting-email">Email (Account)</label>
                <input type="email" id="setting-email" readonly>
              </div>
              <div class="form-field">
                <label for="setting-phone">Phone Number</label>
                <input type="tel" id="setting-phone" placeholder="Your phone number">
              </div>
              <div class="form-field">
                <label for="setting-ign">Change IGN (In-Game Name)</label>
                <input type="text" id="setting-ign" placeholder="New IGN">
              </div>
              <div class="form-field">
                <label for="setting-level">Player Level</label>
                <input type="number" id="setting-level" readonly>
              </div>
              <div class="form-field">
                <label for="setting-currency">In-Game Currency</label>
                <input type="number" id="setting-currency" readonly>
              </div>
              <button id="save-account-btn" class="btn btn-primary">Save Account Info</button>
            </div>
            
            <div class="card">
              <h3>Security</h3>
              <div class="form-field">
                <label for="setting-pass">New Password</label>
                <input type="password" id="setting-pass" placeholder="New Password">
              </div>
              <div class="form-field">
                <label for="setting-pass-confirm">Confirm Password</label>
                <input type="password" id="setting-pass-confirm" placeholder="Confirm Password">
              </div>
              <button class="btn btn-primary" onclick="alert('Password changed (prototype)')">Change Password</button>
            </div>
            
            <div class="card">
              <h3>Payment Verification (GCash)</h3>
              <div class="form-field">
                <label for="setting-gcash-name">Full Name (GCash)</label>
                <input type="text" id="setting-gcash-name" placeholder="Juan Dela Cruz">
              </div>
              <div class="form-field">
                <label for="setting-gcash-number">GCash Number</label>
                <input type="tel" id="setting-gcash-number" placeholder="09171234567">
              </div>
              <button id="verify-payment-btn" class="btn btn-primary">Verify Payment</button>
              <p id="verification-status" class="small-muted" style="margin-top: 1rem;"></p>
            </div>

          </div>
        </section>
        
        <section id="page-shop" class="dashboard-page">
          <h2>Shop</h2>
          
          <div id="verification-prompt" style="display: none;">
            Please <a id="verify-link">verify your payment method</a> in Settings to enable the shop.
          </div>
          
          <div class="shop-grid">
            
            <div class="shop-items-column">
              <div class="card">
                <h3>Weekly Shop</h3>
                <div class="items" id="store-items">
                  </div>
              </div>
              
              <div class="card">
                <h3>Season Battlepass</h3>
                <div class="item card">
                  <div class="item-image-placeholder">Battlepass Banner</div>
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                      <div class="title">Season 1 Battlepass</div>
                      <div class="small-muted">Unlock 100 Tiers</div>
                    </div>
                    <div style="text-align:right">₱350</div>
                  </div>
                  <div style="margin-top:auto;display:flex;gap:8px;justify-content:flex-end">
                    <button class="btn btn-primary add-cart" data-id="bp1">Add to Cart</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="sidebar-content">
              <div class="card">
                <h4>Your Cart</h4>
                <div class="cart-list" id="cart-list">(cart empty)</div>
                <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
                  <strong id="cart-total">Total: ₱0</strong>
                  <button id="checkout" class="btn btn-primary">Checkout</button>
                </div>
              </div>
              
              <div class="card">
                <h4>Payment</h4>
                <p class="small-muted">Your saved payment method will be used.</p>
                <button class="btn btn-primary" id="proceed-to-payment" style="width: 100%;" onclick="alert('Proceeding to secure payment (prototype)...')">Proceed to Payment</button>
              </div>
            </div>
            
          </div>
        </section>
        
        <section id="page-achievements" class="dashboard-page">
          <h2>Achievements</h2>
          <div class="content-grid">
            
            <div class="card">
              <h3>Missions</h3>
              <ul class="ach-list">
                <li class="done">Craft your first tool</li>
                <li class="done">Build a shelter</li>
                <li class="not-done">Reach the other side of the island</li>
              </ul>
            </div>
            
            <div class="card">
              <h3>Easter Eggs</h3>
              <ul class="ach-list">
                <li class="done">Found the message in a bottle</li>
                <li class="not-done">Discovered the hidden waterfall cave</li>
              </ul>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
              <h3>Achievement Log</h3>
              
              <div class="ach-category">
                <h4>Common</h4>
                <ul class="ach-list">
                  <li class="done">Chop 10 trees</li>
                  <li class="done">Catch 5 fish</li>
                  <li class="not-done">Survive 3 days</li>
                </ul>
              </div>
              
              <div class="ach-category">
                <h4>Uncommon</h4>
                <ul class="ach-list">
                  <li class="done">Craft a backpack</li>
                  <li class="not-done">Build a wooden foundation</li>
                </ul>
              </div>
              
              <div class="ach-category">
                <h4>Rare</h4>
                <ul class="ach-list">
                  <li class="not-done">Tame a boar</li>
                  <li class="not-done">Find the ancient ruins</li>
                </ul>
              </div>
            </div>
            
          </div>
        </section>
        
      </main>
      
    </div>
    
  </div>

  <script>
    // --- Auth Check & Initial Data Load ---
    const userEmail = localStorage.getItem('loggedInUser');
    let userData = userEmail ? JSON.parse(localStorage.getItem(userEmail)) : null;

    if (!userEmail || !userData || userEmail === 'admin@bth.com') {
      window.location.href = 'login.html'; 
    } else {
      document.getElementById('sidebar-welcome').textContent = `User: ${userData.username}`;
      document.getElementById('overview-level').textContent = userData.level || 1;
      
      document.getElementById('setting-ign').value = userData.username || '';
      document.getElementById('setting-email').value = userEmail;
      document.getElementById('setting-phone').value = userData.phone || '';
      document.getElementById('setting-level').value = userData.level || 1;
      document.getElementById('setting-currency').value = userData.inGameCurrency || 0;
      
      if (userData.payment) {
        document.getElementById('setting-gcash-name').value = userData.payment.name || '';
        document.getElementById('setting-gcash-number').value = userData.payment.number || '';
      }
      
      const announcementData = JSON.parse(localStorage.getItem('bth_announcement') || '{}');
      if (announcementData && announcementData.message) {
        document.getElementById('announcement-card').style.display = 'block';
        document.getElementById('announcement-text').textContent = announcementData.message;
        document.getElementById('announcement-meta').textContent = `Posted by admin@bth.com on ${new Date(announcementData.timestamp).toLocaleString()}`;
      }
    }

    // --- Logout Logic ---
    function logout() {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'index.html'; 
    }
    document.getElementById('logoutBtn').onclick = logout;
    document.getElementById('mobile-logout').onclick = logout;

    // --- Tab Switching Logic ---
    const navButtons = document.querySelectorAll('.sidebar-nav-btn');
    const contentPages = document.querySelectorAll('.dashboard-page');
    
    function showTab(tabName) {
      navButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
      contentPages.forEach(page => {
        page.classList.toggle('active', page.id === `page-${tabName}`);
      });
    }
    
    navButtons.forEach(btn => {
      if (btn.id === 'mobile-logout') return; 
      btn.addEventListener('click', () => showTab(btn.dataset.tab));
    });

    // --- Settings Save Logic ---
    document.getElementById('save-account-btn').onclick = () => {
      if (!userEmail || !userData) return; 
      
      const newIgn = document.getElementById('setting-ign').value;
      const newPhone = document.getElementById('setting-phone').value;
      
      userData.username = newIgn;
      userData.phone = newPhone;
      
      localStorage.setItem(userEmail, JSON.stringify(userData));
      
      document.getElementById('sidebar-welcome').textContent = `User: ${newIgn}`;
      alert('Account info saved (prototype)');
    };
    
    // --- Payment Verification Logic ---
    const verifyBtn = document.getElementById('verify-payment-btn');
    const verificationStatus = document.getElementById('verification-status');
    const verificationPrompt = document.getElementById('verification-prompt');
    const verifyLink = document.getElementById('verify-link');
    
    verifyLink.onclick = () => showTab('settings');

    function updateVerificationStatus() {
      userData = userEmail ? JSON.parse(localStorage.getItem(userEmail)) : null; 
      if (!userData) { logout(); return; } 

      if (userData.isVerified && userData.payment) {
        verificationStatus.textContent = `Verified with ${userData.payment.method || 'GCash'}: ${userData.payment.name} (${censorNumber(userData.payment.number)})`;
        verifyBtn.textContent = 'Payment Verified';
        verifyBtn.disabled = true;
        
        verificationPrompt.style.display = 'none';
        document.querySelectorAll('.add-cart, #checkout, #proceed-to-payment').forEach(btn => {
          btn.disabled = false;
        });
      } else {
        verificationStatus.textContent = 'Your payment method is not verified.';
        verifyBtn.textContent = 'Verify Payment';
        verifyBtn.disabled = false;
        
        verificationPrompt.style.display = 'block';
        document.querySelectorAll('.add-cart, #checkout, #proceed-to-payment').forEach(btn => {
          btn.disabled = true;
        });
      }
    }
    
    function censorNumber(number) {
        if (!number || number.length <= 4) return number || '';
        return '*'.repeat(number.length - 4) + number.slice(-4);
    }
    
    verifyBtn.addEventListener('click', () => {
      const gcashName = document.getElementById('setting-gcash-name').value;
      const gcashNumber = document.getElementById('setting-gcash-number').value;
      
      if (!gcashName || !gcashNumber) {
        alert('Please enter both your GCash name and number.');
        return;
      }
      
      userData.isVerified = true;
      userData.payment = { method: 'GCash', name: gcashName, number: gcashNumber };
      localStorage.setItem(userEmail, JSON.stringify(userData));
      
      alert('Payment Verified!');
      updateVerificationStatus();
    });

    // --- Store & Cart Logic ---
    const SHOP_ITEMS = JSON.parse(localStorage.getItem('bth_shop_items') || '[]');
    const BATTLEPASS_ITEM = {id:'bp1',name:'Season 1 Battlepass',desc:'Unlock 100 Tiers',price:350,cat:'Battlepass'};
    const ALL_PURCHASABLE_ITEMS = [...SHOP_ITEMS, BATTLEPASS_ITEM];
    
    let CART = JSON.parse(localStorage.getItem('bth_cart')||'[]');
    
    function saveCart(){ 
      localStorage.setItem('bth_cart', JSON.stringify(CART)); 
      renderCart(); 
    }
    
    function renderCart(){
      const list = document.getElementById('cart-list'); 
      list.innerHTML=''; 
      if(CART.length===0){ 
        list.textContent='(cart empty)'; 
        document.getElementById('cart-total').textContent='Total: ₱0'; 
        return; 
      }
      
      let total=0; 
      CART.forEach(ci=>{ 
        const it = ALL_PURCHASABLE_ITEMS.find(s=>s.id===ci.id); 
        if (!it) return;
        total+=it.price*ci.qty; 
        const row = document.createElement('div'); 
        row.className='cart-row'; 
        row.innerHTML = `<div>${it.name} x${ci.qty}</div><div>₱${it.price*ci.qty} <button data-remove=\"${ci.id}\">✕</button></div>`; 
        list.appendChild(row); 
      });
      document.getElementById('cart-total').textContent = `Total: ₱${total}`;
      
      list.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',()=>{ 
        const id=b.dataset.remove; 
        CART = CART.filter(x=>x.id!==id); 
        saveCart(); 
      }));
    }
    
    document.getElementById('checkout').addEventListener('click', ()=>{ 
      if(CART.length===0){ alert('Cart empty'); return;} 
      if (!userData.isVerified || !userData.payment) {
          alert('Please verify your payment method first.');
          return;
      }
      
      let transactions = JSON.parse(localStorage.getItem('bth_transactions') || '[]');
      let total = 0;
      const paymentMethod = userData.payment.method || 'GCash'; 
      const censoredNumber = censorNumber(userData.payment.number);
      const itemsPurchased = []; 
      
      CART.forEach(ci => {
        const it = ALL_PURCHASABLE_ITEMS.find(s => s.id === ci.id);
        if(it) {
          const itemTotal = it.price * ci.qty;
          total += itemTotal;
          itemsPurchased.push(`${it.name} x${ci.qty}`); 
          transactions.push({
            id: `TX-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`, 
            date: new Date().toISOString(),
            userEmail: userEmail,
            itemName: it.name,
            itemDescription: it.desc || '', 
            amount: itemTotal,
            paymentMethod: paymentMethod, 
            censoredAccountNumber: censoredNumber 
          });
        }
      });
      
      localStorage.setItem('bth_transactions', JSON.stringify(transactions));
      alert(`Checkout successful for ₱${total}!\nItems: ${itemsPurchased.join(', ')}\nTransaction logged.`); 
      
      CART=[]; 
      saveCart(); 
    });
    
    // Populate store items
    const storeEl = document.getElementById('store-items');
    storeEl.innerHTML = ''; 
    if (SHOP_ITEMS && SHOP_ITEMS.length > 0) {
        SHOP_ITEMS.forEach(it=>{
          const div = document.createElement('div'); div.className='item card';
          div.innerHTML = `<div class=\"item-image-placeholder\">Item Image</div><div style=\"display:flex;justify-content:space-between;align-items:center\"><div><div class=\"title\">${it.name}</div><div class=\"small-muted\">${it.cat || ''}</div></div><div style=\"text-align:right\">₱${it.price}</div></div><div class=\"small-muted\">${it.desc || ''}</div><div style=\"margin-top:auto;display:flex;gap:8px;justify-content:flex-end\"><button class=\"btn btn-primary add-cart\" data-id=\"${it.id}\">Add to Cart</button></div>`;
          storeEl.appendChild(div);
        });
    } else {
        storeEl.innerHTML = '<p class="small-muted">No items currently available.</p>';
    }

    // Event listener for "Add to Cart" buttons
    document.body.addEventListener('click', e=>{
      if(e.target.classList.contains('add-cart')){
        const id=e.target.dataset.id; 
        const found=CART.find(x=>x.id===id);
        
        if (id === 'bp1' && found) {
          alert('Battlepass is already in your cart.');
          return;
        }
        
        if(found) found.qty++; else CART.push({id,qty:1}); 
        saveCart();
        e.target.textContent = 'Added!';
        setTimeout(()=> { e.target.textContent = 'Add to Cart'; }, 1000);
      }
    });

    // --- Initial Page Load Calls ---
    renderCart();
    updateVerificationStatus(); 

  </script>
</body>
</html>